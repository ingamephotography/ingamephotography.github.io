<!DOCTYPE html>
<html><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="ingame photography">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <title>Prince of Persia – INGAME</title>
  <meta name="author" content="egor chernykh">
  <link rel="stylesheet" href="/css/mystyle.css">
</head><body>
    <div class="container-sm"><header>

</header><nav class="navbar navbar-expand-lg navbar-light bg-light ms-0 ">
  <div class="container">
    <a class="navbar-brand" href="http://ingamephotography.github.io/"><h1>INGAME</h1></a>
    <button class="navbar-toggler" 
      type="button" data-bs-toggle="collapse" 
      data-bs-target="#navbarMain">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarMain">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link" href="http://ingamephotography.github.io/tags">последние публикации</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="http://ingamephotography.github.io/tags">хронология</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="http://ingamephotography.github.io/tags">теги</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="http://ingamephotography.github.io/tags">баттл</a>
        </li>
      </ul>
      <form class="d-flex">
        <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
        <button class="btn btn-outline-success" type="submit">Search</button>
      </form>
    </div>
  </div>
</nav>

<main>
<h2 h2>Prince of Persia</h2>
<p>На протяжении большей части лета я занимался реверс-инжинирингом Prince of Persia: The Sands of Time, чтобы создать для неё свободную камеру, а Егор Черных помогал мне с её тестированием. В результате получились таблица для Cheat Engine (прилагается) и довольно много снимков разной степени случайности (также прилагаются). Пункты ниже описывают процесс их создания с разных сторон — от чисто технических моментов до попыток вчитаться в те режимы зрения, которые предлагают игра и её окрестности.</p>
<ol>
<li>угол обзора</li>
</ol>
<p>Чтобы запустить игру в широкоэкранном разрешении, требуется Widescreen Fix от nemesis 2000 (ps2wide.net/pc.html#popst). В файле конфигурации pop.ini есть параметр fov_multiplier, отвечающий за угол обзора. По умолчанию это 1.0. Я поменял значение в файле на более редкое, чтобы сократить время поиска, запустил игру и нашёл своё значение в памяти процесса с помощью Cheat Engine. Это позволило мне менять угол обзора не в файле, а непосредственно во время игры.</p>
<ol start="2">
<li>Багдадский вор</li>
</ol>
<p>Фильм &ldquo;Багдадский вор&rdquo; (1940), один из ключевых источников вдохновения и для серии Prince of Persia в целом, и для &ldquo;Песков времени&rdquo; в особенности, переполнен ситуациями, так или иначе связанными со зрением:</p>
<ul>
<li>здесь есть принцесса, на которую запрещено смотреть, и на которую Ахмад, тем не менее, смотрит.</li>
<li>когда она, в свою очередь, впервые видит Ахмада, он смотрит на неё из отражения в воде пруда, из-за чего она поначалу принимает его за джинна.</li>
<li>визирь накладывает заклятия при помощи глаз, отчасти гипнотизируя своих жертв, отчасти — занимаясь сглазом.</li>
<li>одно из этих заклятий ослепляет Ахмада до тех пор, пока принцесса не окажется в объятиях визиря.</li>
<li>всевидящее око богини, которое Абу крадёт с её лба (по пути пролезая через её левый глаз), позволяет наблюдать в реальном времени за любым желаемым объектом.</li>
<li>наконец, сам фильм создаёт особую форму синтетического зрения — именно для него была разработана технология хромакея.</li>
</ul>
<p>Всё это, впрочем, не имеет никакого отношения к видеоигре &ldquo;Принц Персии: Пески времени&rdquo;, позаимствовавшей у фильма вовсе не это, а приблизительно всё остальное: структуру, завязанную на продолжительном флэшбэке, экзотический антураж и султана-коллекционера, очередное приобретение которого оказалось роковым. В коллекции султана из &ldquo;Багдадского вора&rdquo; есть и часы (но не песочные, а с маятником), которые таят в себе угрозу апокалиптического масштаба: по мнению визиря, это информационный ресурс, получив доступ к которому, народ мог бы поставить под сомнение власть султана — то есть то, как он распоряжается их и своим временем.</p>
<p>Впрочем, к одной из вышеупомянутых &ldquo;зрительных&rdquo; сцен в игре есть прямая отсылка: как и Абу, принц залазит на огромную голову статуи где-то в Индии, чтобы что-то украсть, но это совершенно точно не свободная камера (а жаль — это бы избавило меня от лишней работы).</p>
<ol start="3">
<li>ReShade</li>
</ol>
<p>Widescreen Fix заменяет d3d9.dll в папке с игрой, и поэтому конфликтует с ReShade, который также заменяет этот файл. Чтобы обойти это, я использовал Ultimate ASI Loader v4.51 от ThirteenAG (github.com/ThirteenAG/Ultimate-ASI-Loader/releases/ta..). Этот инструмент позволяет подключать к играм дополнительные библиотеки в формате .asi, который используется в моддинге игр серии GTA (фактически, asi - это переименованные dll). После его установки переименование d3d9.dll из Widescreen Fix в d3d9.asi и дальнейшее подключение ReShade разрешило конфликт.</p>
<p>Я использовал следующие шейдеры из набора от 2b3: MCMAP (для изменения цвета при помоши LUT), SINV (для инверсии тона), CMMIX (для микширования каналов), TCNC (для имитации техниколоровских цветов &ldquo;Багдадского вора&rdquo;, от которых игра, отчасти стилизованная под японские survival horror-ы, преднамеренно избавилась) и DX (для мультиэкспозиции). Для каждого шейдера я назначил отдельную кнопку-переключатель на клавиатуре, что позволило добиваться сложных настраиваемых наслоений эффектов.</p>
<ol start="4">
<li>координаты</li>
</ol>
<p>Положением камеры в игре управляют как минимум три группы координат.</p>
<ul>
<li>
<p>Те, что я обнаружил в первую очередь, используются для двух альтернативных режимов камеры - видов от первого лица и с высоты птичьего полёта. обе этих камеры предполагались как статичные, так что связанные с ними координаты изменяют действительное положение камеры только в момент, когда игрок переключается на один из этих режимов. То есть если изменять координаты самостоятельно через cheat engine, изменения будут происходить не в реальном времени, а за кадром, и будут применены только при следующем переключении на эту камеру и только если заморозить значения в ячейках, чтобы игра не могла их перезаписать. Так что до конца июня мы с Егором двигали камеру исключительно вслепую.</p>
</li>
<li>
<p>Затем я обнаружил основные координаты, которые описывают положение камеры в любой отдельно взятый момент игрового процесса. Тут же обнаружилась проблема: в отличие от координат &ldquo;статичных&rdquo; камер, эти оказались чувствительны к геометрии уровня: изменяя их, у вас скорее всего не получится провести камеру сквозь твёрдое тело. Использованный мной костыль заключается в том, что эти координаты изменяются синхронно с первыми, и при столкновении со стеной достаточно отключить и снова включить вид от первого лица, чтобы преодолеть препятствие.</p>
</li>
<li>
<p>Работая с игрой в оконном режиме для удобства отслеживания переменных в Cheat Engine (в тот момент я искал ячейки, связанные с направлением взгляда), я обнаружил, что могу изменять параметры камеры, когда окно игры неактивно, но эти изменения не сохраняются, когда я возобновляю игровой процесс. Так я нашёл третьи координаты — и написал скрипт, деляющий их основными. Их преимущество состоит в том, что игра не пытается перезаписать параметры камеры при нарушении каких-либо базовых правил: получившийся режим обзора не пытается вернуть камеру к принцу и исправить угол обзора на дефолтный, как это происходит в стандартном режиме от третьего лица, не запрещает накренивать камеру набок и не останавливает камеру от прохождения сквозь твёрдые тела. Эти же преимущества есть и при работе со вторыми координатами на паузе (см. раздел &ldquo;пауза&rdquo; ниже) — но если выставленные на паузе параметры камеры сбиваются при переходе в реальное время, то здесь становится возможно затаиться и ожидать решающего момента. Увы, как и на паузе, здесь недоступен обзор мышью.</p>
</li>
</ul>
<ol start="5">
<li>пауза</li>
</ol>
<p>Пауза в игре управляется простым бинарным значением — 1 ставит игру на паузу, а 0 снимает с неё. При этом камерой начинают управлять другие координаты, так что, пока я их не обнаружил, с остановленным временем я мог изменять только угол обзора. Я изменил команду, записывающую значение в ячейку, на пустую (nop), и это решило часть проблемы: стало возможным ещё и перемещение камеры. При этом можно без проблем пролететь камерой сквозь стену, но при снятии с паузы камера возвращается в точку, где она прошла сквозь твёрдое тело. Кроме того, было нельзя изменить направление взгляда: обзор мышью всё ещё не работал.</p>
<p>Направление взгляда в игре задаётся трёхмерным вектором, но изначально по неизвестной причине две из составляющих вектора - x и z - не изменялись на паузе, а изменяли вместо этого значение y (то есть можно было посмотреть вверх или вниз, но не по сторонам). Оказалось, что ячейки, ответственные за эти составляющие, на паузе отчего-то меняются на другие. Прямое управление этими переменными с клавиатуры существенно менее удобно, чем обзор мышью, хоть и позволяет при желании большую точность, так что я долгое время не оставлял попыток сделать возможным обзор мышью на паузе.</p>
<p>Я стал искать в процедуре, ответственной за постановку игры на паузу, конкретные строчки кода, отключающие обзор мышью — и нашёл, но их изменение повлекло за собой неожиданный побочный эффект: да, обзор мышью стал возможен, но принц и все противники при снятии игры с паузы теперь подпрыгивали. После нескольких прыжков противники умирали, а игра вылетала. Изменение ответственной за это процедуры по частям не помогло отделить зёрна от плевел: редактирование первой половины процедуры оставляло от принца на паузе только волосы и меч, а редактирование второй позволяло ему прямо на паузе стремительно падать сквозь пол и умирать.</p>
<ol start="6">
<li>на что ты смотришь?</li>
</ol>
<p>Взгляд на Фару в режиме от первого лица провоцирует короткие опциональные диалоги между ней и принцем, разнящиеся в зависимости от этапа прохождения и по-своему иллюстрирующие динамику их отношений: по мере сближения персонажей интонации Фары меняются с возмущённых на лирические, а смущение принца, застигнутого за чересчур пристальным взглядом на свою спутницу, несколько смягчается.</p>
<p>К Фаре можно подобраться и до того, как это происходит по сюжету, и посмотреть на неё — в этом случае можно увидеть, как беззвучно шевелятся её губы, поскольку реплики, соответствующей этому этапу прохождения, не существует.</p>
<p>А если, находясь на раннем этапе игры, продолжить смотреть на Фару после её замечания, за ним последует ещё одно, и камера принудительно переключит вид из первого в третье лицо, превращая игрока и принца из сообщников в соперников — но это ещё не самая странная схема взаимодействия этих троих.</p>
<p>У этих диалогов есть, по всей видимости, два условия: принц должен находиться неподалёку от Фары и камера от первого лица должна быть направлена на неё. Что происходит, когда мы с помощью Cheat Engine отделяем эту камеру от тела принца? Расстояние между камерой и Фарой перестаёт быть важным. Оказываясь в кадре — вне зависимости от того, откуда на неё смотрят — Фара ощущает это и реагирует, но её ответный взгляд и реплика направлены не навстречу камере, а туда, где мы оставили тело принца, в режиме от первого лица невидимое.</p>
<ol start="7">
<li>экранизация</li>
</ol>
<p>Эти опциональные сцены — один из немногих элементов, сохранившихся в экранизации (&ldquo;Принц Персии: Пески времени&rdquo;, Walt Disney Pictures, 2010): здесь принц беззастенчиво заглядывает в вырез сменившей Фару принцессы Тамины, пытаясь высмотреть фиал с драгоценным песком, который позволяет кинжалу перематывать время назад.</p>
<p>Кроме того, в фильм перетекли характерные просчитанные и резкие движения виртуальной камеры, которые можно встретить в катсценах игры и при переключении режимов обзора. Здесь они асссоциируются с тактическим мышлением, доходчивым объяснением плана атаки и иными ситуациями, где необходимо упростить сложные пространственные отношения. Такой поиск кратчайшего пути между двумя образами, расположенными в трёхмерном пространстве, в чём-то аналогичен паркуру — с той разницей, что это не движение тела, а движение мысли. В иных обстоятельствах — например, в самой игре — такие синтаксические приёмы прекрасно вписываются в систему неоклассического, спилберговского киноязыка, построенного вокруг эффективного донесения информации. Но режиссёр, Майк Ньюэлл, как будто слишком увлечён мелочами и фактурами, ещё и допуская порой совершенно контринтуитивные монтажные решения, и в его руках фильм становится мельтешащей, хрупкой, децентрализованной мелодрамой, в которую затесалось несколько механически строгих экшн-сцен.</p>
<p>При всяком удобном случае фильм отсылает к Assassin&rsquo;s Creed, указывая на преемственность серий даже тогда, когда это не совсем легально (так появляются &ldquo;хассансины&rdquo;, как будто сбежавшие из мокбастера от студии Asylum). Собственно, паркур здесь — тоже из серии-потомка: это не постапокалиптическая необходимость, как в разрушенном дворце из оригинальной игры, а маргинальный способ городского существования, параллельный &ldquo;нормальному&rdquo; перемещению и социальной жизни, и в связи с этим очень удобный для кратких пересказов исторических эпох, оформленных в виде скоростных рейсов из грязи в князи и обратно.</p>
<ol start="8">
<li>управление</li>
</ol>
<p>~ — отключить HUD (нажмите, когда его нет на экране, и в следующий раз, когда он должен будет появиться — то есть при ранении или вступлении в бой — он просто не появится)</p>
<p>Numpad 0 - пауза
CapsLock - переключиться на альтернативную камеру (третий набор координат)</p>
<p>Numpad +/- изменить угол обзора</p>
<p>Numpad 5/8 - перемешать камеру по оси x
Numpad 7/9 - перемещать камеру по оси y
Numpad 4/6 - перемещать камеру по оси z</p>
<p>I,J,K,L,U,O — изменить направление взгляда (необходимо только на паузе/с альтернативной камерой)</p>
<p>Numpad 1/3 - управлять креном камеры</p>
<p>Numpad * - запомнить/забыть текущее положение камеры от первого лица (или вида с высоты птичьего полёта)</p>
<p>читы:
Ctrl+1 - неуязвимость ко всему, кроме падений в пропасть
Ctrl+2 - бесконечное замедление времени</p>
<p>странная штука:
Ctrl+4 - сбить направляющие камеры (любое движение мыши или изменение направления взгляда с клавиатуры полупредсказуемым образом наклоняет камеру. крайне дезориентирует в силу того, что направление движения принца нового положения камеры не учитывает)</p>

        </main><footer>

</footer></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    
   
</body>

</html>